<!doctype html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Send ⇄ Receiver Prototype — Fixed</title>
  <style>
    :root{--bg:#071425;--card:#071122;--muted:#9aa4b2;--accent:#327acd;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:var(--bg);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .phone{width:380px;max-width:95vw;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:18px;padding:12px;box-shadow:0 12px 36px rgba(2,6,23,0.6);position:relative;display:block;box-sizing:border-box}
    .phone.full{width:100vw !important;height:100vh !important;max-width:none !important;border-radius:0 !important;padding:18px !important;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;}
    .home{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .icon{background:var(--glass);padding:14px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer}
    .icon .label{margin-top:8px;font-size:13px;color:var(--muted)}
    .screen{margin-top:12px;background:#041321;border-radius:12px;padding:8px;min-height:580px;overflow:hidden;position:relative;box-sizing:border-box}
    .screen.full{flex:1;width:calc(100% - 36px);max-width:none;margin-top:12px;min-height:0;border-radius:10px;}
    .wallpaper-picker{display:flex;gap:8px;align-items:center;padding:8px}
    .wp-thumb{width:44px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    .navbar{display:flex;align-items:center;gap:10px;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .back{width:36px;height:36px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .nav-title{font-weight:600}
    .list{padding:12px}
    .list-item{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .clickable{color:var(--accent);cursor:pointer}
    .inbox-list{display:flex;flex-direction:column;padding:8px;gap:8px}
    .chat{padding:14px;border-radius:12px;background:rgba(255,255,255,0.02);margin:8px 0}
    .msg{padding:10px;border-radius:10px;max-width:85%}
    .from-me{align-self:flex-end;background:linear-gradient(180deg, rgba(50,205,50,0.15), rgba(50,205,50,0.10))}
    .from-them{align-self:flex-start;background:rgba(255,255,255,0.03)}
    .row{display:flex;gap:8px;padding:12px}
    input[type=text],input[type=number],input[type=password]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:inherit}
    .btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#021;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
   .top-notif{
  position: fixed;
  left: 50%;
  top: 18px;
  transform: translateX(-50%);
  transition: all .35s ease;
  background: linear-gradient(90deg,#032 0%, #054 100%);
  padding: 12px 16px;
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.6);
  z-index:1000;
  cursor: pointer;

  opacity: 0;           /* hidden by default */
  pointer-events: none; /* prevent accidental clicks when hidden */
}
.top-notif.show{
  opacity: 1;
  pointer-events: auto; /* clickable when visible */
}

    
    .modal{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.55);visibility:hidden;opacity:0;transition:opacity .2s, visibility .2s;z-index:40}
    .modal.show{visibility:visible;opacity:1}
    .modal-card{background:#021222;padding:18px;border-radius:12px;min-width:280px;text-align:center}
    .modal-card .choices{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .small{font-size:20px;color: white;}
    .hidden{display:none}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .balance{font-weight:700}
    .page{box-sizing:border-box}
    .mpesa-link{color:#0b69ff !important;text-decoration:underline !important}
  </style>
</head>
<body>
  <div class="phone" id="app">
    <!-- headerRow contains wallpaper-picker; we'll hide it while in flows -->
    <div id="headerRow" style="display:flex;justify-content:space-between;align-items:center">
      <div class="wallpaper-picker" id="wallpaperPicker">
        <div class="small">Trickster</div>
        <div class="wp-thumb" id="wpDefault" title="Default" style="background:linear-gradient(90deg,#032,#054);"></div>
        <div class="wp-thumb" id="wpBlue" title="Blue" style="background:linear-gradient(90deg,#012,aqua);"></div>
        <div class="wp-thumb" id="wpDark" title="Dark" style="background:linear-gradient(90deg,#000,#111);"></div>
      </div>
      <div style="font-size:13px;color:var(--muted)"></div>
    </div>

    <div class="home" id="mainIcons" style="margin-top:10px">
      <div class="icon" id="senderIcon" title="Send">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M22 2L11 13" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div class="label">Send</div>
      </div>
      <div class="icon" id="receiverIcon" title="Receiver">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div class="label">Messages</div>
      </div>
      <div class="icon" title="Inert"><svg width="36" height="36" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="white" stroke-width="1.2"/></svg><div class="label">Inert</div></div>
    </div>

    <div class="top-notif" id="topNotif">New message received</div>
<div class="screen" id="screen">

      <div id="landing" class="page">
        <div style="padding:18px;text-align:center">
          <h3>MIGUEL'S WORLD</h3>
          <p class="muted"></p>
        </div>
      </div>

      <!-- Sender pages -->
      <div id="senderHome" class="page hidden">
        <div class="navbar"><div class="back" id="senderBack">←</div><div class="nav-title">M-PESA</div></div>
        <div class="list">
          <div class="list-item"><div>Safaricom+ <span class="muted"></span></div></div>
          <div class="list-item " id="openB">M-PESA</div>
        </div>
      </div>

      <div id="senderBpage" class="page hidden">
        <div class="navbar"><div class="back" id="senderBBack">←</div><div class="nav-title">M-PESA</div></div>
        <div class="list">
          <div class="list-item " id="itemC">Send Money</div>
          <div class="list-item">Withdraw Cash</div>
          <div class="list-item">Buy Airtime</div>
          <div class="list-item">Loans and Savings</div>
          <div class="list-item " id="itemG">Lipa na M-PESA</div>
          <div class="list-item">My Account</div>
        </div>
      </div>

      <!-- C flow -->
      <div id="enterPhone" class="page hidden">
        <div class="navbar"><div class="back" id="phoneBack">←</div><div class="nav-title">Send Money</div></div>
        <div style="padding:12px">
          <div class="small">(primary) Enter phone no.</div>
          <div class="row"><input id="phoneInput" type="text"/><button class="btn" id="phoneNext">Send</button></div>
           </div>
      </div>

      <div id="enterAmount" class="page hidden">
        <div class="navbar"><div class="back" id="amountBack">←</div><div class="nav-title">(primary) Enter Amount</div></div>
        <div style="padding:12px">
          <div class="row"><input id="amountInput" type="number" ><button class="btn" id="amountNext">Send</button></div>
          
        </div>
      </div>

      <div id="enterPin" class="page hidden">
        <div class="navbar"><div class="back" id="pinBack">←</div><div class="nav-title">(primary) Enter PIN</div></div>
        <div style="padding:12px">
          <div class="row"><input id="pinInput" type="password" maxlength="4" placeholder="••••" /><button class="btn" id="pinNext">Send</button></div>
                  </div>
      </div>

      <div id="enterName" class="page hidden">
        <div class="navbar"><div class="back" id="nameBack">←</div><div class="nav-title">(primary) Enter Name</div></div>
        <div style="padding:12px">
          <div class="row"><input id="nameInput" type="text" placeholder="Recipient name" /><button class="btn" id="nameNext">Send</button></div>
          
        </div>
      </div>

      <div id="senderConfirm" class="page hidden">
        <div class="navbar"><div class="back" id="confirmBack">←</div><div class="nav-title">Confirm</div></div>
        <div style="padding:12px"><div class="chat" id="confirmSummary"></div></div>
      </div>

      <!-- Receiver pages -->
      <div id="receiverHome" class="page hidden">
        <div class="navbar"><div class="back" id="receiverBack">←</div><div class="nav-title">Messages</div></div>
        <div style="padding:8px">
          <div class="inbox-list" id="inboxList"></div>
        </div>
      </div>

      <div id="conversationBaby" class="page hidden">
        <div class="navbar"><div class="back" id="convBack">←</div><div class="nav-title">M-PESA</div></div>
        <div style="padding:10px">
          <div id="chatWindow" style="display:flex;flex-direction:column;gap:8px;max-height:440px;overflow:auto;padding-bottom:10px"></div>
        </div>
      </div>

      <!-- G page and flows -->
      <div id="Gpage" class="page hidden">
        <div class="navbar"><div class="back" id="Gback">←</div><div class="nav-title">Lipa na M-PESA</div></div>
        <div class="list" style="padding:12px">
          <div class="list-item">Pay Bill</div>
          <div class="list-item " id="GJ">Buy Goods and Services</div>
          <div class="list-item " id="GK">Pochi La Biashara</div>
        </div>
      </div>

      <div id="enterTill" class="page hidden">
        <div class="navbar"><div class="back" id="tillBack">←</div><div class="nav-title">(primary) Enter Till</div></div>
        <div style="padding:12px"><div class="row"><input id="tillInput" type="text" /><button class="btn" id="tillNext">Send</button></div></div>
      </div>

      <div id="tillAmount" class="page hidden">
        <div class="navbar"><div class="back" id="tillAmountBack">←</div><div class="nav-title">(primary) Enter Amount</div></div>
        <div style="padding:12px"><div class="row"><input id="tillAmountInput" type="number" step="0.01" /><button class="btn" id="tillAmountNext">Send</button></div></div>
      </div>

      <div id="tillPin" class="page hidden">
        <div class="navbar"><div class="back" id="tillPinBack">←</div><div class="nav-title">(primary) Enter PIN</div></div>
        <div style="padding:12px"><div class="row"><input id="tillPinInput" type="password" maxlength="4" placeholder="••••" /><button class="btn" id="tillPinNext">Send</button></div></div>
      </div>

      <!-- single name step only for Till -->
      <div id="tillName1" class="page hidden">
        <div class="navbar"><div class="back" id="tillName1Back">←</div><div class="nav-title">(primary) Enter Name</div></div>
        <div style="padding:12px"><div class="row"><input id="tillName1Input" type="text" placeholder="Name" /><button class="btn" id="tillName1Next">Send</button></div></div>
      </div>

      <!-- Number flow screens -->
      <div id="enterNumberFlow" class="page hidden">
        <div class="navbar"><div class="back" id="numBack">←</div><div class="nav-title">(primary) Enter Number</div></div>
        <div style="padding:12px"><div class="row"><input id="numInput" type="text" /><button class="btn" id="numNext">Send</button></div></div>
      </div>

      <div id="numAmount" class="page hidden">
        <div class="navbar"><div class="back" id="numAmountBack">←</div><div class="nav-title">(primary) Enter Amount</div></div>
        <div style="padding:12px"><div class="row"><input id="numAmountInput" type="number" step="0.01" /><button class="btn" id="numAmountNext">Send</button></div></div>
      </div>

      <div id="numPin" class="page hidden">
        <div class="navbar"><div class="back" id="numPinBack">←</div><div class="nav-title">(primary) Enter PIN</div></div>
        <div style="padding:12px"><div class="row"><input id="numPinInput" type="password" maxlength="4" placeholder="••••" /><button class="btn" id="numPinNext">Send</button></div></div>
      </div>

      <!-- single name step only for Number -->
      <div id="numName1" class="page hidden">
        <div class="navbar"><div class="back" id="numName1Back">←</div><div class="nav-title">(primary) Enter Name</div></div>
        <div style="padding:12px"><div class="row"><input id="numName1Input" type="text" /><button class="btn" id="numName1Next">Send</button></div></div>
      </div>

    </div>
  </div>

  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}

    // short DOM helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // pages map
    const pages = {};
    [
      'landing','senderHome','senderBpage','enterPhone','enterAmount','enterPin','enterName','senderConfirm',
      'receiverHome','conversationBaby','Gpage','enterTill','tillAmount','tillPin','tillName1',
      'enterNumberFlow','numAmount','numPin','numName1'
    ].forEach(id => pages[id] = document.getElementById(id));

    const phoneEl = document.getElementById('app');
    const headerRow = document.getElementById('headerRow');
    const wallpaperPicker = document.getElementById('wallpaperPicker');
    const mainIcons = document.getElementById('mainIcons');
    const screenEl = document.getElementById('screen');

    // show function now forces wallpaper-picker hidden when not landing
    function show(id) {
      Object.values(pages).forEach(p => p && p.classList.add('hidden'));
      if (pages[id]) pages[id].classList.remove('hidden');

      if (id === 'landing') {
        // show header/wallpaper
        headerRow.classList.remove('hidden');
        wallpaperPicker.style.display = 'flex';
        mainIcons.classList.remove('hidden');
        phoneEl.classList.remove('full');
        screenEl.classList.remove('full');
      } else {
        // hide header/wallpaper (explicit)
        headerRow.classList.add('hidden');
        wallpaperPicker.style.display = 'none';
        mainIcons.classList.add('hidden');
        phoneEl.classList.add('full');
        screenEl.classList.add('full');
      }
    }

    // storage & daily limit
    const STORAGE_KEY = 'sr_ext_fixed_v3';
    const LS_DAILY_REMAIN = 'sr_daily_remaining_fixed_v3';
    const LS_DAILY_DATE = 'sr_daily_date_fixed_v3';
    const DAILY_LIMIT = 500000.00;

    let backend = { balance:3000.00, messages:{}, transactions:[] };

    function getTodayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function ensureDailyAllowance(){
      const today = getTodayKey();
      const savedDate = localStorage.getItem(LS_DAILY_DATE);
      if (savedDate !== today){
        localStorage.setItem(LS_DAILY_REMAIN, DAILY_LIMIT.toFixed(2));
        localStorage.setItem(LS_DAILY_DATE, today);
      }
    }
    function getDailyRemaining(){
      ensureDailyAllowance();
      return parseFloat(localStorage.getItem(LS_DAILY_REMAIN));
    }
    function setDailyRemaining(v){
      localStorage.setItem(LS_DAILY_REMAIN, Number(v).toFixed(2));
    }

    function loadBackend(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) backend = JSON.parse(raw);
      }catch(e){}
      ensureDailyAllowance();
    }
    function saveBackend(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(backend));
    }

    // wallpaper picks
    $('#wpDefault').addEventListener('click', ()=> document.body.style.background='linear-gradient(180deg,#071425,#071a2a)');
    $('#wpBlue').addEventListener('click', ()=> document.body.style.background='linear-gradient(180deg,#021b3a,#053a7a)');
    $('#wpDark').addEventListener('click', ()=> document.body.style.background='linear-gradient(180deg,#000,#111)');

    // nav wiring (icons)
    $('#senderIcon').addEventListener('click', ()=> { resetInputs(); show('senderHome'); });
    $('#receiverIcon').addEventListener('click', ()=> { renderInbox(); show('receiverHome'); });

    // top-level back nav
    $('#senderBack').addEventListener('click', ()=> show('landing'));
    $('#receiverBack').addEventListener('click', ()=> show('landing'));
    $('#senderBBack').addEventListener('click', ()=> show('senderHome'));
    $('#phoneBack').addEventListener('click', ()=> show('senderBpage'));
    $('#amountBack').addEventListener('click', ()=> show('enterPhone'));
    $('#pinBack').addEventListener('click', ()=> show('enterAmount'));
    $('#nameBack').addEventListener('click', ()=> show('enterPin'));
    $('#confirmBack').addEventListener('click', ()=> show('senderHome'));
    $('#convBack').addEventListener('click', ()=> show('receiverHome'));
    $('#Gback').addEventListener('click', ()=> show('senderBpage'));

    // buttons that open pages
    $('#openB').addEventListener('click', ()=> show('senderBpage'));
    $('#itemC').addEventListener('click', ()=> { resetInputs(); show('enterPhone'); });
    $('#itemG').addEventListener('click', ()=> show('Gpage'));
    $('#GJ').addEventListener('click', ()=> { resetInputs(); show('enterTill'); });
    $('#GK').addEventListener('click', ()=> { resetInputs(); show('enterNumberFlow'); });

    // back in flows where needed
    $('#tillBack').addEventListener('click', ()=> show('Gpage'));
    $('#tillAmountBack').addEventListener('click', ()=> show('enterTill'));
    $('#tillPinBack').addEventListener('click', ()=> show('tillAmount'));
    $('#tillName1Back').addEventListener('click', ()=> show('tillPin'));

    $('#numBack').addEventListener('click', ()=> show('Gpage'));
    $('#numAmountBack').addEventListener('click', ()=> show('enterNumberFlow'));
    $('#numPinBack').addEventListener('click', ()=> show('numAmount'));
    $('#numName1Back').addEventListener('click', ()=> show('numPin'));

    // session temp
    let sessionTemp = { phone:'', name:'', amount:0, pin:'', template:'C' };
    function resetInputs(){
      sessionTemp = { phone:'', name:'', amount:0, pin:'', template:'C' };
      $$('#screen input').forEach(i => i.value = '');
    }

    // C flow
    $('#phoneNext').addEventListener('click', ()=>{
      const val = $('#phoneInput').value.trim();
      if(!/^[0-9]{9,12}$/.test(val)){ alert('Enter digits only, 9-12 digits'); return; }
      sessionTemp.phone = val;
      sessionTemp.template = 'C';
      show('enterAmount');
    });
    $('#amountNext').addEventListener('click', ()=>{
      const v = parseFloat($('#amountInput').value);
      if(isNaN(v) || v<=0){ alert('Enter valid amount'); return; }
      if(v > backend.balance){ alert('Insufficient balance'); return; }
      if(v > getDailyRemaining()){ alert("Amount exceeds today's remaining transaction allowance of Ksh " + Number(getDailyRemaining()).toFixed(2)); return; }
      sessionTemp.amount = Math.round(v*100)/100;
      show('enterPin');
    });
    $('#pinNext').addEventListener('click', ()=>{
      const p = $('#pinInput').value.trim();
      if(!/^[0-9]{4}$/.test(p)){ alert('PIN must be 4 digits'); return; }
      sessionTemp.pin = p;
      show('enterName');
    });
    // nameNext goes straight to send (no confirm)
    $('#nameNext').addEventListener('click', ()=>{
      const n = $('#nameInput').value.trim();
      if(!n){ alert('Enter name'); return; }
      sessionTemp.name = n;
      sessionTemp.template = 'C';
      processSend('C');
    });

    // Till (J) flow: single name step only
    $('#tillNext').addEventListener('click', ()=>{
      const t = $('#tillInput').value.trim();
      if(!/^[0-9]{3,12}$/.test(t)){ alert('Enter valid Till digits'); return; }
      sessionTemp.till = t;
      sessionTemp.template = 'J';
      show('tillAmount');
    });
    $('#tillAmountNext').addEventListener('click', ()=>{
      const v = parseFloat($('#tillAmountInput').value);
      if(isNaN(v) || v<=0){ alert('Enter valid amount'); return; }
      if(v > backend.balance){ alert('Insufficient balance'); return; }
      if(v > getDailyRemaining()){ alert("Amount exceeds today's remaining transaction allowance of Ksh " + Number(getDailyRemaining()).toFixed(2)); return; }
      sessionTemp.amount = Math.round(v*100)/100;
      show('tillPin');
    });
    $('#tillPinNext').addEventListener('click', ()=>{
      const p = $('#tillPinInput').value.trim();
      if(!/^[0-9]{4}$/.test(p)){ alert('PIN must be 4 digits'); return; }
      sessionTemp.pin = p;
      show('tillName1');
    });
    // single name input then immediate send (no repeat confirm)
    $('#tillName1Next').addEventListener('click', ()=>{
      const n = $('#tillName1Input').value.trim();
      if(!n){ alert('Enter name'); return; }
      sessionTemp.name = n;
      sessionTemp.template = 'J';
      processSend('J');
    });

    // Number (K) flow: single name step only
    $('#numNext').addEventListener('click', ()=>{
      const v = $('#numInput').value.trim();
      if(!/^[0-9]{9,12}$/.test(v)){ alert('Enter valid number'); return; }
      sessionTemp.phone = v;
      sessionTemp.template = 'K';
      show('numAmount');
    });
    $('#numAmountNext').addEventListener('click', ()=>{
      const v = parseFloat($('#numAmountInput').value);
      if(isNaN(v) || v<=0){ alert('Enter valid amount'); return; }
      if(v > backend.balance){ alert('Insufficient balance'); return; }
      if(v > getDailyRemaining()){ alert("Amount exceeds today's remaining transaction allowance of Ksh " + Number(getDailyRemaining()).toFixed(2)); return; }
      sessionTemp.amount = Math.round(v*100)/100;
      show('numPin');
    });
    $('#numPinNext').addEventListener('click', ()=>{
      const p = $('#numPinInput').value.trim();
      if(!/^[0-9]{4}$/.test(p)){ alert('PIN must be 4 digits'); return; }
      sessionTemp.pin = p;
      show('numName1');
    });
    $('#numName1Next').addEventListener('click', ()=>{
      const n = $('#numName1Input').value.trim();
      if(!n){ alert('Enter name'); return; }
      sessionTemp.name = n;
      sessionTemp.template = 'K';
      processSend('K');
    });

    // Main processSend
    function processSend(forcedTemplate){
      const tpl = forcedTemplate || sessionTemp.template || 'C';
      if(!sessionTemp.name){ alert('Missing name'); return; }
      if(!sessionTemp.amount || sessionTemp.amount <= 0){ alert('Missing amount'); return; }
      if(sessionTemp.amount > backend.balance){ alert('Insufficient balance'); return; }
      const dailyRemaining = getDailyRemaining();
      if(sessionTemp.amount > dailyRemaining){ alert("Amount exceeds today's remaining transaction allowance of Ksh " + Number(dailyRemaining).toFixed(2)); return; }

      const code = generateCode();
      let fee = 0.00;
      if(tpl === 'C') fee = 10.00; else fee = 0.00;

      // update internal balances
      backend.balance = Math.round((backend.balance - sessionTemp.amount - fee) * 100) / 100;
      const newDaily = Math.round((dailyRemaining - sessionTemp.amount) * 100) / 100;
      setDailyRemaining(newDaily);
      saveBackend();

      // timestamp formatting
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const yy = String(now.getFullYear()).slice(-2);
      let hours = now.getHours();
      const minutes = String(now.getMinutes()).padStart(2,'0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12; if(hours === 0) hours = 12;

      // build transcript per template
      let transcript = '';
      if(tpl === 'C'){
        transcript = `${code} Confirmed. Ksh${Number(sessionTemp.amount).toFixed(2)} sent to ${sessionTemp.name} ${sessionTemp.phone ? sessionTemp.phone : ''} on ${dd}/${mm}/${yy} at ${hours}:${minutes} ${ampm}. New M-PESA balance is Ksh${backend.balance.toFixed(2)}. Transaction cost, Ksh${fee.toFixed(2)}. Amount you can transact within the day is ${Number(newDaily).toFixed(2)}. Earn interest daily on Ziidi MMF, Dial *334#`;
      } else if(tpl === 'J'){
        transcript = `${code} Confirmed. Ksh${Number(sessionTemp.amount).toFixed(2)} paid to ${sessionTemp.name} on ${dd}/${mm}/${yy} at ${hours}:${minutes} ${ampm}.\nNew M-PESA balance is Ksh${backend.balance.toFixed(2)}. Transaction cost, Ksh0.00.\nAmount you can transact within the day is ${Number(newDaily).toFixed(2)}.\nSave frequent Tills for quick payment on M-PESA app <a class="mpesa-link" href="https://bit.ly/mpesalnk" target="_blank">https://bit.ly/mpesalnk</a>`;
      } else if(tpl === 'K'){
        transcript = `${code} Confirmed. Ksh${Number(sessionTemp.amount).toFixed(2)} sent to ${sessionTemp.name} on ${dd}/${mm}/${yy} at ${hours}:${minutes} ${ampm}. New M-PESA balance is Ksh${backend.balance.toFixed(2)}. Transaction cost, Ksh0.00. Amount you can transact within the day is ${Number(newDaily).toFixed(2)}. Sign up for Lipa Na M-PESA Till online <a class="mpesa-link" href="https://m-pesaforbusiness.co.ke" target="_blank">https://m-pesaforbusiness.co.ke</a>`;
      } else {
        transcript = `${code} Confirmed. Ksh${Number(sessionTemp.amount).toFixed(2)} to ${sessionTemp.name} on ${dd}/${mm}/${yy} at ${hours}:${minutes} ${ampm}. New M-PESA balance is Ksh${backend.balance.toFixed(2)}.`;
      }

      // store message (HTML allowed)
if(!backend.messages['baby']) backend.messages['baby'] = [];
backend.messages['baby'].push({
  text: transcript,
  ts: now.getTime(),
  code: code,
  name: sessionTemp.name,
  phone: sessionTemp.phone || '',
  amount: Number(sessionTemp.amount).toFixed(2),
  balance: backend.balance.toFixed(2),
  dailyRemaining: Number(newDaily).toFixed(2)
});
backend.transactions.push({code,amount:sessionTemp.amount,fee,ts:now.getTime(),template:tpl,name:sessionTemp.name,phone:sessionTemp.phone||''});
saveBackend();

// trigger popup immediately
triggerReceiverPopup(backend.messages['baby'][backend.messages['baby'].length - 1]);

// update confirm summary and show
$('#confirmSummary').innerHTML = `<div style="font-weight:700">Sent</div><div class="small">${transcript.replace(/\n/g,'<br>')}</div>`;
show('senderConfirm');

// reset
sessionTemp = { phone:'', name:'', amount:0, pin:'', template:'C' };

    }

    // code generator
    function generateCode(){
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const arr = ['T','J']; // start with TJ

  // generate 5 more letters
  for(let i=0;i<5;i++) arr.push(letters.charAt(Math.floor(Math.random()*letters.length)));

  // generate 3 digits
  for(let i=0;i<3;i++) arr.push(String(Math.floor(Math.random()*10)));

  // shuffle only the letters and digits after 'TJ' (optional, or leave order)
  const toShuffle = arr.slice(2); // everything after TJ
  for(let i=toShuffle.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [toShuffle[i],toShuffle[j]] = [toShuffle[j],toShuffle[i]];
  }
  return ['T','J',...toShuffle].join('');
}


    // inbox rendering & conversation
    function renderInbox(){
      const list = $('#inboxList');
      list.innerHTML = '';
      const msgs = backend.messages['baby'] || [];
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `<div><strong>M-pesa</strong><div class="small">${msgs.length} messages</div></div><div class="muted">▶</div>`;
      item.addEventListener('click', ()=> openConversation('baby'));
      list.appendChild(item);
    }
    function openConversation(name){
      const conv = backend.messages[name] || [];
      const win = $('#chatWindow');
      win.innerHTML = '';
      conv.forEach(m => {
        const el = document.createElement('div');
        el.className = 'msg from-them';
        el.innerHTML = m.text;
        win.appendChild(el);
      });
      show('conversationBaby');
      setTimeout(()=> { showTemporaryTopFull(conv[conv.length-1]); }, 200);
    }
    function showTemporaryTop(text){
      const el = $('#topNotif');
      el.textContent = text;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 4500);
    }
    function showTemporaryTopFull(entry){
  if(!entry) return;
  const date = new Date(entry.ts);
  const datePart = date.toLocaleDateString('en-GB');
  const timePart = date.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
  const payload = `${entry.phone} · ${entry.name} · Ksh${Number(entry.amount).toFixed(2)} · ${datePart} ${timePart} · ${entry.code} · Bal Ksh${Number(entry.balance).toFixed(2)}`;
  
  const el = $('#topNotif');
  el.textContent = payload;
  el.classList.add('show');

  // click on notification opens receiver
  el.onclick = () => {
    renderInbox();
    show('receiverHome');
    el.classList.remove('show');
    el.onclick = null;
  };

  // auto-hide after 4.5s
  setTimeout(() => {
    el.classList.remove('show');
    el.onclick = null; // remove click after timeout
  }, 4500);
}

    function triggerReceiverPopup(entry){ showTemporaryTopFull(entry); }


    const topNotif = document.getElementById('topNotif');
topNotif.addEventListener('click', () => {
  show('receiverHome');  // open inbox
  topNotif.classList.remove('show'); // hide notification immediately
});


    // init
    loadBackend();
    show('landing');

    // debugging helpers
    window.backend = backend;
    window.getDailyRemaining = getDailyRemaining;
    window.saveBackend = saveBackend;
    window.loadBackend = loadBackend;
  </script>
</body>
</html>